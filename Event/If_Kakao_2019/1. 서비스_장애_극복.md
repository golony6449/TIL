# 서비스장애를 극복하는 게임플랫폼 구축하기

## 서비스장애

* 뭔가 잘 안되는 상황



## 발생과정

* API 에러 => 속도 지연 => 장비에서 처리불가 => 전체 정지
* 매우 빠르게 진행
* 전체가 뻗지않는게 중요



## 요인

* HW
* SW: OS, WAS, DB, 설정, **Source Code**



## 장애허용 시스템

* 발생 최소화, 자동 해결, 장애전파차단
* 특성: **이중화, 장애차단**, 장애 분리 ==> 동작 지속



## 이중화 구성

* 물리적 이중화
* 오토스케일, 다중커넥션(재접속 지연 방지)
* 데이터저장소: Master, Slave 구성 => Endpoint 전환으로 장애대응
* 데이터 기록 로직 이중화



## 우편함 처리사례

* 값 검증 이후 원격 DB 저장중 실패
* 데이터 유실 가능성도 있음
* 해결: 실패시 로걸 DB에 저장 후, 복구 배치 작업으로 해결
* 중복 없이 처리되는 것을 확인: DB 기록과정에서 고유 ID를 발급해 해결



## 로그인 처리 사례

* ID Provider에 계정정보 의존 상황
* IDP 이증 이후 자체 인증 토큰 생성해 클라이언트에 전달 
* 만료된 플랫폼 인증 토큰이 전달되었을때, IDP에 확인중 오류발생 => 자체인증 토큰확인 방식으로 전환
* 단기간이라면 허용 가능한 범주라고 판단했음 (개발팀에서)
* 신규유저는 허용할 수 없음 (필수정보 확인 불가능) => 장애 당시 신규유저는 비율은 매우 낮음



## 장애 차단 / 장애 알람

### 멀티 스레드 상황

* 하나의 스레드 풀을 공유해 모든 API를 처리할때, 특정 API가 지연될때 해당기능이 스레드풀이 모든 스레드를 점유할 수 있음
* 중요기능에 대한 처리불가상황 발생
* 스레드풀을 공유해, 기능별, 중요도별 분리를 통해 다른 서비스의 간섭을 줄일 수 있음



### 외부 API

* 한 스레드에서 모든 로그인을 처리, 로그인에는 여러 외부서버에 접근함
* 특정 서버에서 지연발생시, 스레드 점유시간이 길어짐 ==> 스레드 고갈
* 개선: 각 서버에서 응답수신시 수신값을 다른 스레드에 전달해 작업 수행
* 장점: 시간단축, 스레드풀 고갈 현상 방지 가능



### 데이터에 의한 문제 발생 - push 토큰 등록 과정 (동일 키 데이터 업데이트)

* primary 키로 푸시 토큰 사용
* 에뮬레이터에 대한 고려가 되지 않음 ==> 에뮬레이터는 동일한 토큰값 사용
* 같은 PK에 대해 수정시 Write Lock에 의한 지연 발생 ==> 전체 DB로 영향 확대 가능
* 개선: 비정상 토큰을 미리 검증 후 관리자에게 전달해 DB 기록 여부 결정 (기준점 합의 필요)



## 장애 감지 / 알람 시스템

* 물리적: Cloud Watch 등 서비스를 모니터링하고, 메신저로 알림 전송
* API 모니터링: 서버 구동 => API 관리서버로 정보 전송 => 테스트 툴에서 테스트 => 테스트 결과를 모니터링 서버로 전달 => Health Check 시작 => 문제발생시 알람 
* 장점: 에러 발생을 추적할 수 있음
* 단점: 엄청난 알람양 ==> 그룹핑 후 그룹별 발송 빈도 조정 and 임계치 설정 (임계치를 넘어야 발송)