# 초당옥수수 10000만/sec 처리

## 초당옥수수

* 당분함량이 높은 옥수수
* 수확이전 주문접수 ==> 수확과 동시에 택배접수
* 배송지연 사유, 일정 안내 필수
* 일정 기간 이상 송장등록이 안되면 즉시/자동 주문취소
* 취소를 막기위해 배송지연안내는 중요한 기능
* TMS



## Legacy

* 문제점: 배치처리, 복잡한 비즈니스 로직, 단일 스레드에서 반복작업으로 수행
* 미션: 실시간 발송, 리팩토링



### 실시간

* 레거시: 지연요청 REST API 호출 => DB에 저장 => `fork`, `join`으로 배치처리
* 개선: 배송지연 API 오출 => 대기큐에 저장 => 



### 리팩토링

* 요청 처리에 대한 인증: `annotation` 적용으로 가독성 향상



### 처리속도 개선

* 반복 작업시 병목 현상 발생
* 인증 => 비즈니스 처리(대부분) => TMS 발송
* 개선: 비동기 워커로 병목지점을 분산처리
* 인증 후 비즈니스 대기 큐에 전달 => 비즈니스 로직 처리 후 발송 대기큐에 전달



## 액터가 된 비동기

* 하나의 대기큐를 여러머신의 많은 컨슈머가 처리
* 스케일 아웃으로 확장 가능
* 공유자료가 없기 때문에 간단하게 분산 가능
* `Spring`의 `SimpleRabbitListenerContainerFactory`, `Listener`별 `Consumer` 커스텀 설정
* `min`, `max` 값 지정 가능



### 자동 재처리, 실패 감지

* 자동 재처리 => 횟수 초과시 알림
* 큐, 큐 retriable(재처리용) => 컨슈머에서 get 후 ack, nack(이후 dead상태) 반환
* 실패시: cnt 증가, `letter` 수정 ==> 재시도로 해결
* 실패: cnt가 임계값 돌파 => 실패큐에 적재 => 배치처리로 실패 원인 메시지 처리, 개발자에게 알림



## RabbitMQ

* 메시지 헤더와 큐 속설을 활용해 재처리 실패 전략 수립 가능



## 액터 모델

* 각 비즈니스 단위를 액터로 구성
* 액터는 수평적으로 확대할 수 있어야 함
* TODO:  액터 메시지 추적, 



## 배포없이 롤백

* 동적으로 설정가능한 스위치를 이용해 레거시코드와 새로운 코드를 전환가능
* 초기에는 1시간 정도 테스트로 동작 ==> 로그 분석 후 실제 배포
* 